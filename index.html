<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App Salud Mental</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <!-- Navegaci√≥n -->
    <nav
      class="flex justify-around bg-blue-500 text-white p-4 fixed bottom-0 w-full z-10"
    >
      <button id="btnLogin" onclick="mostrarPantalla('login')">Login</button>
      <button id="btnRegistro" onclick="mostrarPantalla('registro')">
        Registro
      </button>
      <button id="btnForo" onclick="mostrarPantalla('temas')" class="hidden">
        Foro
      </button>
      <button
        id="btnEvaluaciones"
        onclick="mostrarPantalla('evaluaciones')"
        class="hidden"
      >
        Tests
      </button>
      <button id="btnGuias" onclick="mostrarPantalla('guias')" class="hidden">
        Gu√≠as
      </button>
      <button id="btnAgenda" onclick="mostrarPantalla('agenda')" class="hidden">
        Agendar
      </button>
      <button id="btnLogout" onclick="cerrarSesion()" class="hidden">
        Logout
      </button>
    </nav>

    <main class="pt-10 pb-20 px-6">
      <section id="bienvenida" class="pantalla hidden">
        <h2 class="text-3xl font-bold mb-4">
          Bienvenido, <span id="usuarioNombre"></span> üëã
        </h2>
        <p class="text-lg">
          Selecciona "Foro" para ver los temas y participar.
        </p>
      </section>

      <section id="login" class="pantalla">
        <h2 class="text-2xl font-bold mb-4">Iniciar Sesi√≥n</h2>
        <form onsubmit="iniciarSesion(event)">
          <input
            type="email"
            id="emailLogin"
            placeholder="Email"
            class="w-full p-2 border rounded mb-2"
          />
          <input
            type="password"
            id="passwordLogin"
            placeholder="Contrase√±a"
            class="w-full p-2 border rounded mb-2"
          />
          <div id="errorLogin" class="error mb-2"></div>
          <button class="bg-green-600 text-white w-full p-2 rounded">
            Entrar
          </button>
        </form>
      </section>

      <section id="registro" class="pantalla">
        <h2 class="text-2xl font-bold mb-4">Registro</h2>
        <form id="formRegistro" onsubmit="registrarUsuario(event)">
          <input
            type="text"
            id="nombreRegistro"
            placeholder="Nombre"
            class="w-full p-2 border rounded mb-2"
          />
          <input
            type="email"
            id="emailRegistro"
            placeholder="Email"
            class="w-full p-2 border rounded mb-2"
          />
          <input
            type="password"
            id="passwordRegistro"
            placeholder="Contrase√±a"
            class="w-full p-2 border rounded mb-2"
          />
          <div id="errorRegistro" class="error mb-2"></div>
          <button class="bg-blue-600 text-white w-full p-2 rounded">
            Registrarse
          </button>
        </form>
      </section>

      <section id="temas" class="pantalla hidden">
        <h2 class="text-2xl font-bold mb-4">Temas del Foro</h2>
        <div id="formCrearTema" class="mb-6 hidden">
          <h3 class="text-xl font-semibold mb-2">Nuevo Tema</h3>
          <input
            id="tituloTema"
            placeholder="T√≠tulo"
            class="w-full p-2 border rounded mb-2"
          />
          <textarea
            id="descripcionTema"
            placeholder="Descripci√≥n"
            class="w-full p-2 border rounded mb-2"
          ></textarea>
          <button
            onclick="crearTema()"
            class="bg-blue-700 text-white w-full p-2 rounded"
          >
            Publicar Tema
          </button>
        </div>
        <div id="listaTemas" class="space-y-2 mb-4"></div>
        <section id="mensajesSection" style="display: none">
          <h3 class="text-xl font-bold mb-2">Mensajes del Tema</h3>
          <div id="listaMensajes" class="space-y-2 mb-2"></div>
          <input
            id="nuevoMensaje"
            placeholder="Escribe tu mensaje..."
            class="w-full p-2 border rounded mb-2"
          />
          <button
            onclick="publicarMensaje()"
            class="bg-purple-600 text-white w-full p-2 rounded"
          >
            Enviar
          </button>
        </section>
      </section>

      <section id="evaluaciones" class="pantalla hidden">
        <h2 class="text-2xl font-bold mb-4">
          Autoevaluaci√≥n del Estado An√≠mico
        </h2>
        <form id="formEvaluacion" onsubmit="enviarEvaluacion(event)">
          <!-- Preguntas omitidas para brevedad -->
          <button
            type="submit"
            class="bg-green-600 text-white p-2 rounded w-full"
          >
            Enviar Evaluaci√≥n
          </button>
        </form>
      </section>

      <section id="agenda" class="pantalla hidden">
        <h2 class="text-2xl font-bold mb-4">Agendar una Cita</h2>
        <form id="formCita" class="space-y-4" onsubmit="agendarCita(event)">
          <input
            type="datetime-local"
            id="fechaCita"
            required
            class="w-full p-2 border rounded"
          />
          <textarea
            id="motivoCita"
            required
            class="w-full p-2 border rounded"
            placeholder="Motivo"
          ></textarea>
          <button
            type="submit"
            class="bg-green-600 text-white w-full p-2 rounded hover:bg-green-700"
          >
            Agendar Cita
          </button>
        </form>
        <div id="respuestaCita" class="mt-4 text-green-700 font-semibold"></div>
      </section>

      <section id="guias" class="pantalla hidden">
        <h2 class="text-2xl font-bold mb-4">Material de Apoyo</h2>
        <div class="flex gap-4 mb-4">
          <button
            onclick="cargarImagenes('Guias')"
            class="bg-blue-600 text-white px-4 py-2 rounded"
          >
            Ver Gu√≠as
          </button>
          <button
            onclick="cargarImagenes2('T√©cnicas')"
            class="bg-purple-600 text-white px-4 py-2 rounded"
          >
            Ver T√©cnicas
          </button>
        </div>
        <div
          id="contenedorImagenes"
          class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"
        ></div>
      </section>
    </main>

    <script type="module" src="auth.js"></script>
    <script type="module" src="foro.js"></script>
    <script type="module" src="evaluacion.js"></script>
    <script type="module" src="cita.js"></script>
    <script type="module" src="imagenes.js"></script>

    <script type="module">
      import { API_AUTH } from './config.js';
      import { cargarTemas } from './foro.js';

      window.mostrarPantalla = function (id) {
        document
          .querySelectorAll('.pantalla')
          .forEach((p) => p.classList.add('hidden'));
        const pantalla = document.getElementById(id);
        if (pantalla) pantalla.classList.remove('hidden');
      };

      function actualizarNavbar(logeado) {
        document.getElementById('btnLogin').classList.toggle('hidden', logeado);
        document
          .getElementById('btnRegistro')
          .classList.toggle('hidden', logeado);
        document
          .getElementById('btnLogout')
          .classList.toggle('hidden', !logeado);
        document.getElementById('btnForo').classList.toggle('hidden', !logeado);
        document
          .getElementById('btnEvaluaciones')
          .classList.toggle('hidden', !logeado);
        document
          .getElementById('btnGuias')
          .classList.toggle('hidden', !logeado);
        document
          .getElementById('btnAgenda')
          .classList.toggle('hidden', !logeado);
        const formCrearTema = document.getElementById('formCrearTema');
        if (formCrearTema) formCrearTema.classList.toggle('hidden', !logeado);
      }

      async function verificarSesion() {
        try {
          const res = await fetch(`${API_AUTH}/me`, {
            method: 'GET',
            credentials: 'include',
          });
          if (!res.ok) throw new Error();

          const data = await res.json();
          document.getElementById('usuarioNombre').textContent =
            data.usuario || '';
          window.mostrarPantalla('bienvenida');
          actualizarNavbar(true);
          cargarTemas();
        } catch (e) {
          window.mostrarPantalla('login');
          actualizarNavbar(false);
        }
      }

      document.addEventListener('DOMContentLoaded', verificarSesion);
    </script>
  </body>
</html>
